box: billryan/gitbook:base

build:
    steps:
        - script:
            name: build
            code: |
                cd $WERCKER_SOURCE_DIR
                gitbook build

push:
    box:
        id: nginx:alpine
        cmd: /bin/sh
    steps:
        - script:
            name: install dependencies
            code: |
                apk add --update curl bash
        - script:
            name: mv static files
            code: |
                rm -rf /usr/share/nginx/html/*
                mv $WERCKER_SOURCE_DIR/_book/* /usr/share/nginx/html
        - internal/docker-push:
            registry: https://registry.hub.docker.com
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
            repository: wodby/wodby-docs
            tag: latest, $WERCKER_GIT_BRANCH
            entrypoint: /usr/local/bin/docker-entrypoint.sh
            cmd: nginx -g 'daemon off;'

deployment:
    steps:
        - script:
            name: deployment
            code: |
                curl -sS \
                        -H "Content-type: application/json" \
                        -H "Authorization: token ${WODBY_API_TOKEN}" \
                        -X POST https://api.wodby.com/api/v2/bundles/deploy?org_id="${WODBY_ORG_UUID}"\&service_image=wodby/wodby-docs:"${WERCKER_GIT_BRANCH}"\&cause="${WERCKER_GIT_COMMIT}"
